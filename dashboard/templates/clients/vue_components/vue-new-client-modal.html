{% load i18n %}
{% load static %}
<script>

app.component('v-new-client', {
    delimiters: ['[[', ']]'],
    data: function(){
        return{
            showModal: false,
            form: {
                name: '',
                lastname: '',
                email: '',
                'phoneNumber': ''
            },
            fields: ['name', 'lastname', 'email', 'phoneNumber'],
            errors: []
        };
    },
    props: [],
    emits: [],
    template:
    `
    <div class="flex items-end">
        <div class="py-4">
            <button class="modal-button" @click="changeModal(true)">Crear usuario</button>
        </div>
        <!-- Main modal -->
        <div class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50" v-if="showModal">
            <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
      
            <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
              <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                  <p class="text-2xl font-bold">Nuevo cliente [[ form.name ]]</p>
                  <div class="modal-close cursor-pointer z-50" @click="changeModal(false)">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                      <path d="M18 1.5l-1.5-1.5-7.5 7.5-7.5-7.5-1.5 1.5 7.5 7.5-7.5 7.5 1.5 1.5 7.5-7.5 7.5 7.5 1.5-1.5-7.5-7.5z"/>
                    </svg>
                  </div>
                </div>
      
                <div class="modal-body">
                    <h3 class="text-lg font-bold mb-2">Formulario</h3>

                    <form @submit.prevent="submitForm">
                      <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2" for="name">
                          Nombre
                        </label>
                        <input v-model="form.name"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                               id="name"
                               type="text"
                               placeholder="Ingresa el nombre">
                      </div>
                      <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2" for="name">
                          Apellidos
                        </label>
                        <input v-model="form.lastname"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                               id="name"
                               type="text"
                               placeholder="Ingresa los apellidos">
                      </div>
                      <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2" for="email">
                          Correo
                        </label>
                        <input v-model="form.email"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                               id="email"
                               type="email"
                               placeholder="Ingresa el correo">
                      </div>
                      <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2" for="name">
                          numero de celular
                        </label>
                        <input v-model="form.phoneNumber"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                               id="name"
                               type="text"
                               placeholder="Ingresa el numero de celular">
                      </div>
              
                      <div class="flex justify-end">
                        <button class="modal-close px-4 bg-gray-500 p-3 rounded-lg text-white hover:bg-gray-400" @click="showModal = false">Cerrar</button>
                        <button type="submit"
                                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Guardar
                        </button>
                      </div>
                    </form>
                </div>
      
                <div class="modal-footer flex justify-end pt-2">
                  
                </div>
              </div>
            </div>
        </div>

    </div>
    `,
    methods: {
      changeModal(value) {
        this.clearForm()
        this.showModal = value
      },

      clearForm() {
        this.form.name = ""
        this.form.lastname = ""
        this.form.email = ""
        this.form.phoneNumber = ""
      },

      submitForm() {
        this.errors = []
          for (const field of this.fields) {
            if (!this.form[field]) {
              this.errors.push(`El campo ${field} es obligatorio.`);
            }
          }

          if (this.errors == 0) {
            axios.post("createClient", {
              user: this.form
            }, {
              headers: {
                'X-CSRFToken': csrftoken
              }
            })
            .then(response => {
                if (response.data == "created") {
                  Swal.fire('El usuario fue creado con exito')
                }
                else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: `El usuario con el correo ${this.form.email} ya existe`,
                    footer: '<a href="">Why do I have this issue?</a>'
                  })
                }
            }).catch(error => {
                console.error('There was an error!', error);
            });
          } 

      },
    },
    mounted: function () {},
    beforeUnmount() {},
    computed: {}
});

</script>
